# Zapier Integration Guide - Phase 2

## Overview

This guide provides step-by-step instructions for integrating the Discourse AI assistant with Zapier webhooks. The integration allows automatic AI-powered responses to be generated and posted in Discourse forums.

## Prerequisites

- Discourse forum with admin access
- Zapier account (Pro recommended for webhooks)
- Deployed backend service with Discourse integration
- API key configured for the backend service

## Phase 2 Implementation Steps

### Step 1: Discourse Webhook Setup

First, configure Discourse to send webhooks when new posts are created:

1. **Go to Discourse Admin Panel**
   - Navigate to `/admin/api/web_hooks`
   - Click "New Web Hook"

2. **Configure Webhook**:
   ```
   Payload URL: https://hooks.zapier.com/hooks/catch/[YOUR_ZAPIER_WEBHOOK_ID]/
   Content Type: application/json
   Secret: [OPTIONAL_SECRET_KEY]
   
   Which events should trigger this webhook?
   âœ“ Topic Event
   âœ“ Post Event
   
   Which categories should send notifications?
   âœ“ [Select target categories for AI assistance]
   ```

3. **Test the webhook** by creating a test post in the selected category

### Step 2: Zapier Zap Configuration

Create a new Zap with the following configuration:

#### **Trigger: Catch Raw Hook**
```javascript
// This will receive the Discourse webhook payload
// No additional configuration needed
```

#### **Action 1: Code by Zapier - Transform Discourse Data**
```javascript
// Transform Discourse webhook data for our backend
const inputData = inputData; // Zapier's webhook payload

// Extract post information
const post = {
  title: inputData.topic?.title || 'Untitled Post',
  content: inputData.post?.raw || inputData.post?.cooked || '',
  url: `${inputData.site_url}/t/${inputData.topic?.id}/${inputData.post?.id}`,
  category: inputData.topic?.category?.name || 'General',
  user: {
    username: inputData.post?.username || 'unknown',
    trust_level: inputData.post?.trust_level || 0
  }
};

// Additional context
const context = {
  tags: inputData.topic?.tags || [],
  previous_replies_count: inputData.topic?.posts_count || 0,
  urgency: determineUrgency(post.content)
};

// Configuration
const config = {
  max_response_length: 1500,
  tone: 'helpful',
  include_code_examples: true
};

// Helper function to determine urgency
function determineUrgency(content) {
  const urgentKeywords = ['urgent', 'asap', 'critical', 'emergency', 'help!'];
  const lowPriorityKeywords = ['question', 'wondering', 'curious'];
  
  const contentLower = content.toLowerCase();
  
  if (urgentKeywords.some(keyword => contentLower.includes(keyword))) {
    return 'high';
  } else if (lowPriorityKeywords.some(keyword => contentLower.includes(keyword))) {
    return 'low';
  }
  return 'medium';
}

// Return the transformed payload
output = {
  post: post,
  context: context,
  config: config,
  // Pass through original data for reference
  original_topic_id: inputData.topic?.id,
  original_post_id: inputData.post?.id,
  site_url: inputData.site_url
};
```

#### **Action 2: Webhooks by Zapier - Send to AI Backend**
```javascript
// Configuration
URL: https://your-backend-service.vercel.app/api/discourse-response
Method: POST
Headers: {
  "Authorization": "Bearer YOUR_DISCOURSE_API_KEY",
  "Content-Type": "application/json"
}

// Body (use output from previous step)
{
  "post": {{post}},
  "context": {{context}},
  "config": {{config}}
}
```

#### **Action 3: Code by Zapier - Process AI Response**
```javascript
// Process the AI response and decide whether to post
const aiResponse = inputData; // Response from AI backend

// Quality checks
const shouldPost = aiResponse.success && 
                   aiResponse.response.should_post && 
                   aiResponse.response.confidence !== 'LOW';

// Format the response for Discourse
let discourseContent = '';

if (shouldPost) {
  discourseContent = formatForDiscourse(aiResponse.response.content, aiResponse.sources);
} else {
  // Log for manual review
  console.log('AI response needs manual review:', aiResponse.response.reasoning);
}

function formatForDiscourse(content, sources) {
  let formatted = content;
  
  // Add source references
  if (sources && sources.length > 0) {
    formatted += '\n\n---\n**References:**\n';
    sources.forEach((source, index) => {
      formatted += `${index + 1}. [${source.title}](${source.url})\n`;
    });
  }
  
  // Add bot signature
  formatted += '\n\n*This response was generated by AI assistant. Please let me know if you need clarification on any part!*';
  
  return formatted;
}

// Return decision and formatted content
output = {
  should_post: shouldPost,
  content: discourseContent,
  confidence: aiResponse.response.confidence,
  reasoning: aiResponse.response.reasoning,
  topic_id: inputData.original_topic_id,
  original_post_id: inputData.original_post_id,
  site_url: inputData.site_url,
  processing_time: aiResponse.metadata.processing_time_ms
};
```

#### **Action 4: Filter by Zapier - Only Post High Quality Responses**
```javascript
// Only continue if should_post is true
Continue only if: should_post equals true
```

#### **Action 5: HTTP Request - Post to Discourse**
```javascript
// Post the AI response to Discourse
URL: {{site_url}}/posts.json
Method: POST
Headers: {
  "Api-Key": "YOUR_DISCOURSE_API_KEY",
  "Api-Username": "ai-assistant", // Your bot username
  "Content-Type": "application/json"
}

Body: {
  "topic_id": {{topic_id}},
  "raw": {{content}}
}
```

### Step 3: Error Handling and Monitoring

Add error handling actions:

#### **Action 6: Code by Zapier - Error Logging**
```javascript
// Log errors and send notifications
const error = inputData.error || null;
const success = !error;

if (error) {
  console.error('Discourse AI Integration Error:', error);
  
  // Send notification to admin
  const notification = {
    type: 'error',
    message: error.message,
    timestamp: new Date().toISOString(),
    topic_id: inputData.original_topic_id,
    post_id: inputData.original_post_id
  };
  
  // You can add Slack/email notification here
  output = notification;
} else {
  console.log('Successfully processed Discourse post');
  output = { success: true };
}
```

## Advanced Configuration

### A. Conditional Logic Based on Categories

```javascript
// In the transform step, add category-specific logic
const categoryConfig = {
  'Integration Help': {
    tone: 'helpful',
    max_response_length: 2000,
    include_code_examples: true
  },
  'Troubleshooting': {
    tone: 'professional',
    max_response_length: 1800,
    include_code_examples: true
  },
  'General Discussion': {
    tone: 'friendly',
    max_response_length: 1200,
    include_code_examples: false
  }
};

const categorySpecificConfig = categoryConfig[post.category] || {
  tone: 'helpful',
  max_response_length: 1500,
  include_code_examples: true
};

// Merge with base config
const finalConfig = {
  ...config,
  ...categorySpecificConfig
};
```

### B. Time-Based Delays

```javascript
// Add delays to avoid appearing too automated
const delay = Math.floor(Math.random() * 300) + 60; // 1-5 minutes
await new Promise(resolve => setTimeout(resolve, delay * 1000));
```

### C. User Trust Level Handling

```javascript
// Adjust response based on user trust level
function adjustResponseForUserLevel(content, trustLevel) {
  if (trustLevel <= 1) {
    // Beginner users - add more explanation
    return `Welcome to the community! ðŸ‘‹\n\n${content}\n\nIf you're new to Web3Auth, you might also want to check out our [Getting Started Guide](https://web3auth.io/docs/quick-start).`;
  } else if (trustLevel >= 4) {
    // Advanced users - more technical
    return content.replace(/simple/g, 'straightforward').replace(/easy/g, 'direct');
  }
  return content;
}
```

## Testing and Validation

### Test Scenarios

1. **Basic How-To Question**
   ```json
   {
     "post": {
       "title": "How to integrate Web3Auth with React",
       "content": "I'm trying to set up Web3Auth in my React app. Can someone help?",
       "category": "Integration Help",
       "user": { "username": "developer123", "trust_level": 1 }
     }
   }
   ```

2. **Troubleshooting Request**
   ```json
   {
     "post": {
       "title": "Error: Web3Auth not initializing",
       "content": "Getting 'Web3Auth not initialized' error. What's wrong?",
       "category": "Troubleshooting",
       "user": { "username": "frustrated_dev", "trust_level": 2 }
     }
   }
   ```

3. **Configuration Question**
   ```json
   {
     "post": {
       "title": "Best practices for production setup",
       "content": "What are the recommended settings for production?",
       "category": "Configuration",
       "user": { "username": "senior_dev", "trust_level": 4 }
     }
   }
   ```

### Validation Checklist

- [ ] Webhook triggers correctly on new posts
- [ ] Data transformation preserves all necessary information
- [ ] AI backend returns appropriate confidence levels
- [ ] High-quality responses are posted automatically
- [ ] Low-quality responses are flagged for review
- [ ] Error handling captures and logs issues
- [ ] Response formatting is appropriate for Discourse
- [ ] Source citations are included and formatted correctly

## Performance Monitoring

### Key Metrics to Track

1. **Response Quality**
   - Confidence distribution (HIGH/MEDIUM/LOW)
   - Auto-posting rate
   - Manual review rate

2. **Processing Performance**
   - Average response time
   - Webhook-to-response latency
   - API success rate

3. **Community Engagement**
   - Upvotes/downvotes on AI responses
   - Reply rates to AI responses
   - User satisfaction feedback

### Monitoring Dashboard

Create a simple monitoring dashboard:

```javascript
// Add to your Zapier webhook step
const metrics = {
  timestamp: new Date().toISOString(),
  confidence: aiResponse.response.confidence,
  processing_time: aiResponse.metadata.processing_time_ms,
  should_post: aiResponse.response.should_post,
  category: inputData.post.category,
  user_trust_level: inputData.post.user.trust_level
};

// Send to monitoring service (e.g., Google Sheets, Airtable)
// This step would be added as another action in your Zap
```

## Troubleshooting

### Common Issues

1. **Webhook Not Triggering**
   - Check Discourse webhook configuration
   - Verify category filters
   - Test with manual post creation

2. **AI Response Quality Issues**
   - Review prompt engineering
   - Check keyword extraction
   - Validate document retrieval

3. **Discourse Posting Failures**
   - Verify API credentials
   - Check user permissions
   - Validate content formatting

4. **Rate Limiting**
   - Monitor API quotas
   - Implement exponential backoff
   - Stagger webhook processing

### Debug Mode

Enable debug mode by adding logging:

```javascript
// Add to each Zapier step
console.log('Step Input:', JSON.stringify(inputData, null, 2));
console.log('Step Output:', JSON.stringify(output, null, 2));
```

## Production Deployment

### Pre-Production Checklist

- [ ] Test with sandbox Discourse instance
- [ ] Validate API key security
- [ ] Configure rate limits appropriately
- [ ] Set up monitoring and alerting
- [ ] Create rollback procedures
- [ ] Document operational procedures

### Gradual Rollout

1. **Phase 1**: Enable for one low-traffic category
2. **Phase 2**: Add more categories based on performance
3. **Phase 3**: Enable for all desired categories
4. **Phase 4**: Optimize based on usage patterns

### Monitoring During Rollout

- Monitor response quality metrics
- Track community reception
- Watch for error patterns
- Adjust configuration as needed

## Conclusion

This Zapier integration provides a complete workflow for automated AI-powered Discourse responses. The configuration is flexible and can be adapted for different community needs and use cases.

Remember to:
- Start with a limited rollout
- Monitor quality and community response
- Iterate based on feedback
- Maintain transparency about AI assistance

The integration is designed to enhance community engagement while maintaining high quality standards through comprehensive validation and monitoring. 